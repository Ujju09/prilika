{% extends 'accounting/journal.html' %}
{% load static %}

{% block content %}
<div class="container" style="max-width: 1200px;">
    <header>
        <div class="header-left">
            <nav class="breadcrumb">
                <a href="{% url 'accounting:index' %}">Agent</a>
                <span class="breadcrumb-separator">/</span>
                <a href="{% url 'accounting:journal_view' %}">Journal</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">{{ entry.entry_number }}</span>
            </nav>
            <h1>Journal Entry Details</h1>
        </div>
    </header>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        <!-- Left Column: Transaction Details -->
        <div>
            <!-- Basic Info Card -->
            <div
                style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; font-size: 18px; color: var(--text-main);">{{ entry.entry_number }}</h2>
                        <div style="color: var(--text-muted); font-size: 14px;">
                            {{ entry.transaction_date|date:"F d, Y"}}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <span style="
                            padding: 4px 12px;
                            border-radius: 9999px;
                            font-size: 12px;
                            font-weight: 600;
                            text-transform: uppercase;
                            background: {{ entry.status_bg_color }};
                            color: {{ entry.status_color }};
                        ">
                            {{ entry.get_status_display }}
                        </span>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">NARRATION</label>
                    <div style="font-size: 16px;">{{ entry.narration }}</div>
                </div>

                {% if entry.reference %}
                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">REFERENCE</label>
                    <div>{{ entry.reference }}</div>
                </div>
                {% endif %}

                <div>
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">SOURCE
                        INPUT</label>
                    <div
                        style="background: #f8fafc; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 13px;">
                        {{ entry.source_text }}
                    </div>
                </div>
            </div>

            <!-- Journal Lines -->
            <div
                style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                <h3 style="margin-top: 0; font-size: 16px; margin-bottom: 15px;">Transaction Lines</h3>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50%;">Account</th>
                            <th style="width: 15%;">Code</th>
                            <th style="width: 17%; text-align: right;">Debit (₹)</th>
                            <th style="width: 17%; text-align: right;">Credit (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in entry.lines.all %}
                        <tr>
                            <td>
                                {{ line.account_name }}
                                {% if line.debit > 0 %}<span class="dr-suffix">Dr.</span>{% endif %}
                            </td>
                            <td style="text-align: center;">{{ line.account_code }}</td>
                            <td style="text-align: right;">{% if line.debit > 0 %}{{ line.debit }}{% endif %}</td>
                            <td style="text-align: right;">{% if line.credit > 0 %}{{ line.credit }}{% endif %}</td>
                        </tr>
                        {% endfor %}
                        <tr style="background: #f8fafc; font-weight: 600;">
                            <td colspan="2" style="text-align: right;">Total</td>
                            <td style="text-align: right;">{{ entry.total_amount_calc|default:entry.total_amount }}</td>
                            <td style="text-align: right;">{{ entry.total_amount_calc|default:entry.total_amount }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- AI Reasoning -->
            <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
                <h3 style="margin-top: 0; font-size: 16px; margin-bottom: 15px;">AI Analysis</h3>

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 14px; font-weight: 600; margin-right: 10px;">Confidence Score:</span>
                        <div
                            style="flex-grow: 1; height: 8px; background: #e2e8f0; border-radius: 4px; max-width: 200px; margin-right: 10px;">
                            <div
                                style="width: {% widthratio entry.ai_confidence 1 100 %}%; height: 100%; background: {{ entry.confidence_color }}; border-radius: 4px;">
                            </div>
                        </div>
                        <span style="font-size: 14px; font-weight: 600;">
                            {% widthratio entry.ai_confidence 1 100 %}%
                        </span>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">REASONING</label>
                    <div style="line-height: 1.5; font-size: 14px;">{{ entry.ai_reasoning|linebreaks }}</div>
                </div>

                {% if entry.ai_warnings %}
                <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 4px; padding: 12px;">
                    <strong style="color: #92400e; font-size: 14px;">Warnings:</strong>
                    <ul style="margin: 5px 0 0 20px; color: #92400e; font-size: 14px;">
                        {% for warning in entry.ai_warnings %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Review & Audit -->
        <div>
            <!-- Review and Post Section -->
            {% if entry.status != 'posted' and entry.status != 'rejected' %}
            <div
                style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; font-size: 16px; margin-bottom: 15px;">Review & Post</h3>

                {% if entry.review_notes %}
                <div style="margin-bottom: 20px; padding: 12px; background: #f8fafc; border-radius: 4px; border: 1px solid #e2e8f0;">
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">REVIEW NOTES</label>
                    <div style="font-size: 14px; color: #1e293b;">{{ entry.review_notes }}</div>
                </div>
                {% endif %}

                <form id="review-form" onsubmit="handleReviewSubmit(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 10px;">Review Checklist</label>

                        <div style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="checklist_item" value="Debit-Credit balance verified"
                                    style="margin-right: 8px; width: 16px; height: 16px;" onchange="updateRemarksFromChecklist()">
                                <span style="font-size: 14px;">Debit-Credit balance verified</span>
                            </label>
                        </div>

                        <div style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="checklist_item" value="Account codes are correct"
                                    style="margin-right: 8px; width: 16px; height: 16px;" onchange="updateRemarksFromChecklist()">
                                <span style="font-size: 14px;">Account codes are correct</span>
                            </label>
                        </div>

                        <div style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="checklist_item" value="Narration is clear and complete"
                                    style="margin-right: 8px; width: 16px; height: 16px;" onchange="updateRemarksFromChecklist()">
                                <span style="font-size: 14px;">Narration is clear and complete</span>
                            </label>
                        </div>

                        <div style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="checklist_item" value="Transaction date is accurate"
                                    style="margin-right: 8px; width: 16px; height: 16px;" onchange="updateRemarksFromChecklist()">
                                <span style="font-size: 14px;">Transaction date is accurate</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Additional Remarks (Optional)</label>
                        <textarea name="remarks" rows="3"
                            style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"
                            placeholder="Add any additional notes or concerns..."></textarea>
                    </div>

                    {% if entry.status == 'approved' %}
                    <!-- Show Post button for approved entries -->
                    <button type="button" onclick="handlePost({{ entry.id }})"
                        style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                        Post to Books
                    </button>
                    {% else %}
                    <!-- Show Approve button for non-approved entries -->
                    <button type="submit"
                        style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                        Approve Entry
                    </button>
                    {% endif %}

                    <button type="button" onclick="handleReject({{ entry.id }})"
                        style="width: 100%; padding: 10px; background: #64748b; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        Reject Entry
                    </button>
                </form>

                <div id="review-message" style="margin-top: 15px; display: none; padding: 10px; border-radius: 4px; font-size: 14px;"></div>
            </div>
            {% endif %}

            <!-- Audit Log -->
            <div
                style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; position: sticky; top: 20px;">
                <h3 style="margin-top: 0; font-size: 16px; margin-bottom: 20px;">Audit Log</h3>

                <div style="border-left: 2px solid #e2e8f0; padding-left: 20px; margin-left: 10px;">
                    {% for log in entry.logs.all %}
                    <div style="position: relative; margin-bottom: 25px;">
                        <!-- Timeline dot -->
                        <div
                            style="position: absolute; left: -27px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: white; border: 2px solid var(--primary);">
                        </div>

                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
                            {{ log.timestamp|date:"M d, H:i:s" }}
                        </div>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px; color: var(--text-main);">
                            {{log.get_stage_display }}
                        </div>
                        <div style="font-size: 13px; color: #475569;">{{ log.message }}</div>

                        {% if log.level == 'error' %}
                        <div
                            style="margin-top: 4px; font-size: 12px; color: #dc2626; background: #fee2e2; padding: 4px 8px; border-radius: 4px; display: inline-block;">
                            Error Details Available
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div style="color: var(--text-muted); font-style: italic;">No logs available</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showMessage(message, isError = false) {
        const messageDiv = document.getElementById('review-message');
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        messageDiv.style.background = isError ? '#fee2e2' : '#dcfce7';
        messageDiv.style.color = isError ? '#dc2626' : '#16a34a';
        messageDiv.style.border = isError ? '1px solid #fca5a5' : '1px solid #86efac';
    }

    function updateRemarksFromChecklist() {
        const form = document.getElementById('review-form');
        const checkboxes = form.querySelectorAll('input[name="checklist_item"]');
        const remarksTextarea = form.querySelector('textarea[name="remarks"]');

        // Get all checked items
        const checkedItems = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        // Update textarea with checked items
        remarksTextarea.value = checkedItems.join(', ');
    }

    async function handleReviewSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        const reviewNotes = formData.get('remarks') || '';

        try {
            const response = await fetch('{% url "accounting:approve_entry" entry.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ notes: reviewNotes })
            });

            const result = await response.json();

            if (result.success) {
                showMessage('Entry approved successfully! Reloading...');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showMessage(result.error || 'Failed to approve entry', true);
            }
        } catch (error) {
            showMessage('Network error: ' + error.message, true);
        }
    }

    async function handlePost(entryId) {
        if (!confirm('Are you sure you want to post this entry to the books? This action will finalize the entry.')) {
            return;
        }

        // Collect any remarks from textarea before posting
        const form = document.getElementById('review-form');
        const formData = new FormData(form);
        const remarks = formData.get('remarks') || '';

        // If there are remarks, save them first
        if (remarks.trim()) {
            try {
                await fetch('{% url "accounting:approve_entry" entry.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ notes: remarks })
                });
            } catch (error) {
                console.error('Failed to save remarks:', error);
            }
        }

        // Now post the entry
        try {
            const response = await fetch(`/accounting/api/entries/${entryId}/post/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const result = await response.json();

            if (result.success) {
                showMessage('Entry posted successfully! Reloading...');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showMessage(result.error || 'Failed to post entry', true);
            }
        } catch (error) {
            showMessage('Network error: ' + error.message, true);
        }
    }

    async function handleReject(entryId) {
        const reason = prompt('Please provide a reason for rejecting this entry:');
        if (!reason) return;

        try {
            const response = await fetch(`/accounting/api/entries/${entryId}/reject/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ reason })
            });

            const result = await response.json();

            if (result.success) {
                showMessage('Entry rejected successfully! Reloading...');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showMessage(result.error || 'Failed to reject entry', true);
            }
        } catch (error) {
            showMessage('Network error: ' + error.message, true);
        }
    }
</script>
{% endblock %}